---
date: 2024-03-22T20:34:00
aliases:
  - DIffusion
tags:
  - Diffusion-Model
---

原始的扩散模型里面变量繁多，需要稍微记录一下整个过程中出现的公式、变量等，方便对照代码理解。

**一些资料：**

[【Diffusion模型】由浅入深了解Diffusion，不仅仅是震撼，感受它带给我们的无限可能！！（超详细的保姆级入门教程）_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1ne411u7J6?vd_source=8cee15a84c1239c0b7b758a6e120ebb6)

[What are Diffusion Models?](https://lilianweng.github.io/posts/2021-07-11-diffusion-models/#forward-diffusion-process)

## 前向过程

**主要计算：**

$$ x_t = \sqrt{\alpha_t}x_{t-1} + \sqrt{1-\alpha_t}z_1 $$

其中，

$$ \alpha_t = 1 - \beta_t $$

$\beta_t \in (0.0001, 0.002)$进行均匀采样，递增,$\alpha_t$显然呈递减： 即图像的比重越来越小，噪声比重越来愈大

**推广一下，任意的 $x_t$ 从 $x_0$ 的计算过程为：**

$$ x_t = \sqrt{\bar{\alpha_t}}x_0 + \sqrt{1-\bar{\alpha_t}}z_t $$

其中，$\bar{\alpha}_t = \prod_{i=1}^t \alpha_i$, $z_t$ 为t时刻采样的高斯噪声

**以上从概率论的视角看[暂时不用理会]：**

$$ q(\mathbf{x}_t \vert \mathbf{x}_{t-1}) = \mathcal{N}(\mathbf{x}_t; \sqrt{1 - \beta_t} \mathbf{x}_{t-1}, \beta_t\mathbf{I}) \\ q(\mathbf{x}_{1:T} \vert \mathbf{x}_0) = \prod^T_{t=1} q(\mathbf{x}_t \vert \mathbf{x}_{t-1}) \\ q(\mathbf{x}_t \vert \mathbf{x}_0) = \mathcal{N}(\mathbf{x}_t; \sqrt{\bar{\alpha}_t} \mathbf{x}_0, (1 - \bar{\alpha}_t)\mathbf{I})

$$

## 逆向过程

根据$x_t$求解$x_{t-1}$:

**主目标**

$$ q(\mathbf{x}_{t-1} \vert \mathbf{x}_t, \mathbf{x}_0) = q(\mathbf{x}_t \vert \mathbf{x}_{t-1}, \mathbf{x}_0) \frac{ q(\mathbf{x}_{t-1} \vert \mathbf{x}_0) }{ q(\mathbf{x}_t \vert \mathbf{x}_0) } $$

$$ q(\mathbf{x}_{t-1} \vert \mathbf{x}_t) = q(\mathbf{x}_t \vert \mathbf{x}_{t-1}, \mathbf{x}_0) \frac{ q(\mathbf{x}_{t-1} \vert \mathbf{x}_0) }{ q(\mathbf{x}_t \vert \mathbf{x}_0) } $$

简化，此目标正比于：

$$ \propto\exp \Big( -\frac{1}{2} \big( \color{red}{(\frac{\alpha_t}{\beta_t} + \frac{1}{1 - \bar{\alpha}_{t-1}})} \mathbf{x}_{t-1}^2 - \color{blue}{(\frac{2\sqrt{\alpha_t}}{\beta_t} \mathbf{x}_t + \frac{2\sqrt{\bar{\alpha}_{t-1}}}{1 - \bar{\alpha}_{t-1}} \mathbf{x}_0)} \mathbf{x}_{t-1} \color{black}{ + C(\mathbf{x}_t, \mathbf{x}_0) \big) \Big)} $$

与标准的高斯分布进行对比：

$$ \frac{1}{\sqrt{2\pi\sigma}}\exp\Big(-\frac{(x-\mu)^2}{2\sigma^2}\Big) \propto \exp\Bigg( -\frac{1}{2}\bigg(\frac{1}{\sigma^2}x^2 - \frac{2\mu}{\sigma^2}x +\frac{\mu^2}{\sigma^2}\bigg)\Bigg) $$

看出方差出现在平方之前即红色部分，均值则在蓝色部分出现，可以对均值进行一次计算，约分得到：

$$ \tilde{\boldsymbol{\mu}}_t = \color{cyan}{\frac{1}{\sqrt{\alpha_t}} \Big( \mathbf{x}_t - \frac{1 - \alpha_t}{\sqrt{1 - \bar{\alpha}_t}} \boldsymbol{z}_t \Big)} $$

此时得到均值和方差，然后训练过程就是用神经网络估计这边的噪声$z_t$.

以后就是关键公式了。

$$ \begin{aligned}\tilde{\beta}_t = \color{green}{\frac{1 - \bar{\alpha}_{t-1}}{1 - \bar{\alpha}_t} \cdot \beta_t} \\\tilde{\boldsymbol{\mu}}_t (\mathbf{x}_t, \mathbf{x}_0)&= (\frac{\sqrt{\alpha_t}}{\beta_t} \mathbf{x}_t + \frac{\sqrt{\bar{\alpha}_{t-1} }}{1 - \bar{\alpha}_{t-1}} \mathbf{x}_0)/(\frac{\alpha_t}{\beta_t} + \frac{1}{1 - \bar{\alpha}_{t-1}}) \\&= (\frac{\sqrt{\alpha_t}}{\beta_t} \mathbf{x}_t + \frac{\sqrt{\bar{\alpha}_{t-1} }}{1 - \bar{\alpha}_{t-1}} \mathbf{x}_0) \color{green}{\frac{1 - \bar{\alpha}_{t-1}}{1 - \bar{\alpha}_t} \cdot \beta_t} \\&= \frac{\sqrt{\alpha_t}(1 - \bar{\alpha}_{t-1})}{1 - \bar{\alpha}_t} \mathbf{x}_t + \frac{\sqrt{\bar{\alpha}_{t-1}}\beta_t}{1 - \bar{\alpha}_t} \mathbf{x}_0\\\end{aligned} $$



---
小名同学推荐 B 站李宏毅课程，以后有机会也学习学习
# 扩散模型 - Diffusion Model【李宏毅2023】

